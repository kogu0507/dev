<html><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>èª¿å·ãƒ»èª¿ååŒæœŸãƒ‡ãƒ¢ï¼ˆãƒ‡ãƒ¼ã‚¿å±æ€§ã¨è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰</title>
  <style>
    .smc-key-signature {
      border: 2px solid #a0a0a0;
      padding: 15px;
      margin-bottom: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
    }
    .smc-key-signature h2 {
      margin-top: 0;
      color: #333;
    }
    .svg-display {
      border: 1px solid #ccc;
      padding: 8px;
      min-height: 150px;
      margin-bottom: 12px;
      background-color: white;
    }
    .controls {
      margin-bottom: 8px;
    }
    .hidden {
      display: none !important; /* !important ã§å¼·åˆ¶çš„ã«éè¡¨ç¤ºã«ã™ã‚‹ */
    }
    button {
      padding: 8px 15px;
      margin-right: 5px;
      cursor: pointer;
    }
    select, input[type="text"] {
      padding: 8px;
      margin-right: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container" style="max-width: 800px; margin: 20px auto; padding: 0 15px;">
    <h1>èª¿å·ãƒ»èª¿ååŒæœŸãƒ‡ãƒ¢ï¼ˆãƒ‡ãƒ¼ã‚¿å±æ€§ã¨è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰</h1>
    <p>
      ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€`data-`å±æ€§ã‚’ä½¿ã£ã¦åˆæœŸè¡¨ç¤ºã‚’è¨­å®šã—ãŸ
      `KscKeySignatureController`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¤‡æ•°é…ç½®ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
      å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æŒ™å‹•ã®é•ã„ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
    </p>

    ---

    <div class="smc-key-signature" id="keySelector1" data-svg-display="true" data-controls-display="true">
      <h2>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ 1: ãƒ•ãƒ«æ©Ÿèƒ½</h2>
      <div id="currentKeyInfo1" class="current-key-info" style="margin-bottom:12px;">
        èª¿å·: <span class="key-signature-value">0</span>
        ï¼ èª¿å: <span class="key-name-value">Cãƒ¡ã‚¸ãƒ£ãƒ¼ / Aãƒã‚¤ãƒŠãƒ¼</span>
      </div>
      <div class="svg-display" data-target="svgDisplay">
        <div>ãƒ­ãƒ¼ãƒ‰ä¸­â€¦</div>
      </div>
      <div class="control-panel" data-target="controlPanel">
        <div class="controls">
          <button class="flat-button" disabled="">â™­ã¸</button>
          <button class="sharp-button" disabled="">â™¯ã¸</button>
        </div>
        <div class="controls">
          <label for="keyNameSelect1">èª¿å:</label>
          <select class="key-name-select" id="keyNameSelect1" disabled=""></select>
        </div>
        <div class="controls">
          <input class="key-name-input" type="text" placeholder="ä¾‹: Cãƒ¡ã‚¸ãƒ£ãƒ¼ ã¾ãŸã¯ Aãƒã‚¤ãƒŠãƒ¼" disabled="">
          <button class="set-by-name-button" disabled="">è¨­å®š</button>
        </div>
      </div>
    </div>

    ---

    <div class="smc-key-signature" id="keySelector2" data-svg-display="true" data-controls-display="false">
      <h2>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ 2: SVGã®ã¿è¡¨ç¤º</h2>
      <p>ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€æ“ä½œUIãŒéè¡¨ç¤ºã«ãªã£ã¦ã„ã¾ã™ã€‚</p>
      <div id="currentKeyInfo2" class="current-key-info" style="margin-bottom:12px;">
        èª¿å·: <span class="key-signature-value">0</span>
        ï¼ èª¿å: <span class="key-name-value">Cãƒ¡ã‚¸ãƒ£ãƒ¼ / Aãƒã‚¤ãƒŠãƒ¼</span>
      </div>
      <div class="svg-display" data-target="svgDisplay">
        <div>ãƒ­ãƒ¼ãƒ‰ä¸­â€¦</div>
      </div>
      <div class="control-panel" data-target="controlPanel">
        <div class="controls">
          <button class="flat-button" disabled="">â™­ã¸</button>
          <button class="sharp-button" disabled="">â™¯ã¸</button>
        </div>
        <div class="controls">
          <label for="keyNameSelect2">èª¿å:</label>
          <select class="key-name-select" id="keyNameSelect2" disabled=""></select>
        </div>
        <div class="controls">
          <input class="key-name-input" type="text" placeholder="ä¾‹: Cãƒ¡ã‚¸ãƒ£ãƒ¼ ã¾ãŸã¯ Aãƒã‚¤ãƒŠãƒ¼" disabled="">
          <button class="set-by-name-button" disabled="">è¨­å®š</button>
        </div>
      </div>
    </div>

    ---

    <h3>ã‚°ãƒ­ãƒ¼ãƒãƒ«æ“ä½œãƒ‡ãƒ¢</h3>
    <p>
      å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®IDã‚’ä½¿ã£ã¦ã€JavaScriptã‹ã‚‰å¤–éƒ¨æ“ä½œã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚<br>
      é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ« (F12) ã‚’é–‹ã„ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚
    </p>
    <button id="setKeySelector1ToDMinor">ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ1ã‚’Dãƒã‚¤ãƒŠãƒ¼ã«è¨­å®š</button>
    <button id="setKeySelector2ToEFlatMajor">ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ2ã‚’Eâ™­ãƒ¡ã‚¸ãƒ£ãƒ¼ã«è¨­å®š</button>
    <button id="getSelector1Info">ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ1ã®æƒ…å ±ã‚’å–å¾— (ã‚³ãƒ³ã‚½ãƒ¼ãƒ«)</button>
    <button id="toggleSelector2Controls">ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ2ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ</button>
    <div id="globalStatusMessage" style="margin-top: 10px; color: blue;"></div>

  </div>

  <script type="module">
    // Verovioé–¢é€£ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { CoreProcessor } from 'https://cdn.jsdelivr.net/gh/kogu0507/module@v2.4.0/verovio/core-processor.js';
    import { loadVerovio }   from 'https://cdn.jsdelivr.net/gh/kogu0507/module@v2.4.0/verovio/loader.min.js';

    /**
     * @class KscKeySignatureController
     * èª¿å·ã®è¡¨ç¤ºã¨æ“ä½œã‚’å¸ã‚‹UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã€‚
     * HTMLã®data-å±æ€§ã«ã‚ˆã‚ŠåˆæœŸè¡¨ç¤ºè¨­å®šãŒå¯èƒ½ã€‚
     */
    class KscKeySignatureController {
      /**
       * ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
       * @param {HTMLElement} rootElement - ã“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç´ã¥ãæœ€ä¸Šä½ã®DOMè¦ç´  (ä¾‹: <div class="smc-key-signature">)
       */
      constructor(rootElement) {
        this.rootElement = rootElement;

        // --- DOMè¦ç´ ã®å–å¾— (rootElementå†…ã‹ã‚‰æ¤œç´¢) ---
        // ã‚¯ãƒ©ã‚¹åã§å–å¾—ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å¯¾å¿œ
        this.currentKeyInfoDiv = this.rootElement.querySelector('.current-key-info');
        this.sigSpan = this.rootElement.querySelector('.key-signature-value');
        this.nameSpan = this.rootElement.querySelector('.key-name-value');
        this.svgDisplay = this.rootElement.querySelector('.svg-display');
        this.controlPanel = this.rootElement.querySelector('.control-panel');
        this.flatButton = this.rootElement.querySelector('.flat-button');
        this.sharpButton = this.rootElement.querySelector('.sharp-button');
        this.nameSelect = this.rootElement.querySelector('.key-name-select');
        this.nameInput = this.rootElement.querySelector('.key-name-input');
        this.setByNameButton = this.rootElement.querySelector('.set-by-name-button');

        // --- Verovioé–¢é€£ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ ---
        this.coreProcessor = null;
        this.currentKeySignature = 0; // -7 ã‹ã‚‰ +7 ã¾ã§ã®æ•°å€¤

        // --- data-å±æ€§ã‹ã‚‰åˆæœŸè¨­å®šã‚’èª­ã¿è¾¼ã‚€ ---
        this.initialSvgDisplay = this.rootElement.dataset.svgDisplay === 'true';
        this.initialControlsDisplay = this.rootElement.dataset.controlsDisplay === 'true';

        /**
         * ğŸ“¦ èª¿å·ã®æ•°å€¤ã”ã¨ã®æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         * - major : é•·èª¿ã®åå‰
         * - minor : çŸ­èª¿ã®åå‰
         */
        this.keyDataBySignature = {
          '-7': { major: 'Câ™­ãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Aâ™­ãƒã‚¤ãƒŠãƒ¼' },
          '-6': { major: 'Gâ™­ãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Eâ™­ãƒã‚¤ãƒŠãƒ¼' },
          '-5': { major: 'Dâ™­ãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Bâ™­ãƒã‚¤ãƒŠãƒ¼' },
          '-4': { major: 'Aâ™­ãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Fãƒã‚¤ãƒŠãƒ¼' },
          '-3': { major: 'Eâ™­ãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Cãƒã‚¤ãƒŠãƒ¼' },
          '-2': { major: 'Bâ™­ãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Gãƒã‚¤ãƒŠãƒ¼' },
          '-1': { major: 'Fãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Dãƒã‚¤ãƒŠãƒ¼' },
           '0': { major: 'Cãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Aãƒã‚¤ãƒŠãƒ¼' },
           '1': { major: 'Gãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Eãƒã‚¤ãƒŠãƒ¼' },
           '2': { major: 'Dãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Bãƒã‚¤ãƒŠãƒ¼' },
           '3': { major: 'Aãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Fâ™¯ãƒã‚¤ãƒŠãƒ¼' },
           '4': { major: 'Eãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Câ™¯ãƒã‚¤ãƒŠãƒ¼' },
           '5': { major: 'Bãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Gâ™¯ãƒã‚¤ãƒŠãƒ¼' },
           '6': { major: 'Fâ™¯ãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Dâ™¯ãƒã‚¤ãƒŠãƒ¼' },
           '7': { major: 'Câ™¯ãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Aâ™¯ãƒã‚¤ãƒŠãƒ¼' }
        };

        /**
         * ğŸ”„ èª¿åã‹ã‚‰èª¿å·ã¸ã®é€†å¼•ããƒ‡ãƒ¼ã‚¿
         * major ã¨ minor ã®ä¸¡æ–¹ã‚’ã‚­ãƒ¼ã«ã—ã¦ã€{ signature, major, minor } ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
         */
        this.keyDataByName = {};
        Object.entries(this.keyDataBySignature).forEach(([sig, info]) => {
          this.keyDataByName[info.major] = { signature: +sig, major: info.major, minor: info.minor };
          this.keyDataByName[info.minor] = { signature: +sig, major: info.major, minor: info.minor };
        });

        this._initEventListeners();
      }

      /**
       * @private
       * èª¿å·ã®æ•°å€¤ã‹ã‚‰MEI XMLç”¨ã®accidæ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
       * ä¾‹: 0 -> "0", 1 -> "1s", -2 -> "2f"
       * @param {number} n - èª¿å·ã®æ•°å€¤ (-7 ã‹ã‚‰ +7)
       * @returns {string} MEI XMLã§ä½¿ç”¨ã™ã‚‹accidæ–‡å­—åˆ—
       */
      _getAccidString(n) {
        return n === 0 ? '0' : Math.abs(n) + (n > 0 ? 's' : 'f');
      }

      /**
       * @private
       * MEI XMLæ–‡å­—åˆ—ã‚’çµ„ã¿ç«‹ã¦ã¾ã™ã€‚
       * @param {number} keySig - èª¿å·ã®æ•°å€¤
       * @returns {string} ç”Ÿæˆã•ã‚ŒãŸMEI XMLæ–‡å­—åˆ—
       */
      _buildMei(keySig) {
        const accid = this._getAccidString(keySig);
        return `<?xml version="1.0" encoding="UTF-8"?>
<mei xmlns="http://www.music-encoding.org/ns/mei" meiversion="5.1">
  <meiHead><fileDesc><titleStmt><title>KeySig</title></titleStmt></fileDesc></meiHead>
  <music><body><mdiv><score>
    <scoreDef keysig="${accid}">
      <staffGrp><staffDef n="1" lines="5"
        clef.shape="G" clef.line="2"/></staffGrp>
    </scoreDef>
    <section><measure n="1"><staff n="1"><layer n="1"/></staff></measure></section>
  </score></mdiv></body></music>
</mei>`;
      }

      /**
       * @private
       * ã™ã¹ã¦ã®UIè¦ç´ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
       */
      _initEventListeners() {
        this.flatButton.addEventListener('click', async () => {
          if (this.currentKeySignature > -7) {
            this.currentKeySignature--;
            await this.render();
          }
        });

        this.sharpButton.addEventListener('click', async () => {
          if (this.currentKeySignature < 7) {
            this.currentKeySignature++;
            await this.render();
          }
        });

        this.nameSelect.addEventListener('change', async () => {
          this.currentKeySignature = parseInt(this.nameSelect.value, 10);
          await this.render();
        });

        this.setByNameButton.addEventListener('click', async () => {
          const input = this.nameInput.value.trim();
          this.setKeyByNameString(input);
        });
      }

      /**
       * @private
       * UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
       * @param {boolean} enable - trueã§æœ‰åŠ¹ã€falseã§ç„¡åŠ¹
       */
      _enableUI(enable) {
        this.flatButton.disabled = !enable;
        this.sharpButton.disabled = !enable;
        this.nameSelect.disabled = !enable;
        this.nameInput.disabled = !enable;
        this.setByNameButton.disabled = !enable;
      }

      /**
       * ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚Verovioã®ãƒ­ãƒ¼ãƒ‰ã€UIã®ç”Ÿæˆã€æœ€åˆã®æç”»ã‚’è¡Œã„ã¾ã™ã€‚
       */
      async initialize() {
        try {
          this.svgDisplay.textContent = 'åˆæœŸåŒ–ä¸­â€¦';
          const toolkit = await loadVerovio();
          this.coreProcessor = new CoreProcessor(toolkit);
          this.coreProcessor.setRenderOptions({
            scale: 80, pageWidth: 600, pageHeight: 300, adjustPageHeight: true
          });

          // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ã€ŒMajor / Minorã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
          Object.entries(this.keyDataBySignature).forEach(([sig, info]) => {
            const opt = document.createElement('option');
            opt.value = sig;
            opt.textContent = `${info.major} / ${info.minor}`;
            this.nameSelect.appendChild(opt);
          });

          // dataå±æ€§ã«åŸºã¥ã„ã¦åˆæœŸè¡¨ç¤ºã‚’è¨­å®š
          this.setSvgDisplayVisibility(this.initialSvgDisplay);
          this.setControlPanelVisibility(this.initialControlsDisplay);

          await this.render(); // æœ€åˆã®æç”»
          this._enableUI(true); // UIã‚’æœ‰åŠ¹åŒ–

        } catch (e) {
          this.svgDisplay.textContent = 'åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼';
          console.error(`KscKeySignatureController (ID: ${this.rootElement.id}) åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:`, e);
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’UIã«è¡¨ç¤ºã™ã‚‹å ´åˆ
          // this.rootElement.querySelector('.status-message').textContent = 'ã‚¨ãƒ©ãƒ¼: åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        }
      }

      /**
       * UIã‚’å†æç”»ã—ã¾ã™ã€‚SVGã®ç”Ÿæˆã€è¡¨ç¤ºå€¤ã®æ›´æ–°ã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®åŒæœŸã‚’è¡Œã„ã¾ã™ã€‚
       * @returns {Promise<void>} æç”»ãŒå®Œäº†ã—ãŸã¨ãã«è§£æ±ºã•ã‚Œã‚‹Promise
       */
      async render() {
        if (!this.coreProcessor) {
          console.warn(`KscKeySignatureController (ID: ${this.rootElement.id}): Verovio CoreProcessorãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
          return;
        }

        if (this.svgDisplay) { // svgDisplayãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          this.svgDisplay.textContent = 'SVGç”Ÿæˆä¸­â€¦';
        }
        this._enableUI(false); // æç”»ä¸­ã¯UIã‚’ç„¡åŠ¹åŒ–

        try {
          const svg = await this.coreProcessor.renderSvgFromMei(this._buildMei(this.currentKeySignature));
          if (this.svgDisplay) {
            this.svgDisplay.innerHTML = svg;
          }

          // èª¿å·ã¨èª¿åã‚’è¡¨ç¤ºé ˜åŸŸã«åæ˜ 
          if (this.sigSpan && this.nameSpan) {
            this.sigSpan.textContent = this._getAccidString(this.currentKeySignature);
            const info = this.keyDataBySignature[this.currentKeySignature];
            this.nameSpan.textContent = `${info.major} / ${info.minor}`;
          }


          // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç¾åœ¨ã®èª¿å·ã«åŒæœŸ
          if (this.nameSelect) {
            this.nameSelect.value = this.currentKeySignature.toString();
          }

        } catch (e) {
          if (this.svgDisplay) {
            this.svgDisplay.textContent = 'SVGæç”»ã‚¨ãƒ©ãƒ¼';
          }
          console.error(`KscKeySignatureController (ID: ${this.rootElement.id}) SVGæç”»ã‚¨ãƒ©ãƒ¼:`, e);
          // this.rootElement.querySelector('.status-message').textContent = 'ã‚¨ãƒ©ãƒ¼: SVGã®æç”»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        } finally {
          this._enableUI(true); // æç”»å®Œäº†å¾Œã«UIã‚’æœ‰åŠ¹åŒ–
        }
      }

      // --- å¤–éƒ¨ã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ ---

      /**
       * ç¾åœ¨ã®èª¿å·ã®æ•°å€¤ã‚’è¿”ã—ã¾ã™ã€‚
       * @returns {number} ç¾åœ¨ã®èª¿å·ã®æ•°å€¤ (-7 ã‹ã‚‰ +7)
       */
      getCurrentKeySignatureNumber() {
          return this.currentKeySignature;
      }

      /**
       * ç¾åœ¨ã®èª¿å·ã®è¨˜å·è¡¨ç¾ï¼ˆä¾‹: "0", "1s", "2f"ï¼‰ã‚’è¿”ã—ã¾ã™ã€‚
       * @returns {string} ç¾åœ¨ã®èª¿å·ã®è¨˜å·è¡¨ç¾
       */
      getCurrentKeySignatureAccidString() {
          return this._getAccidString(this.currentKeySignature);
      }

      /**
       * ç¾åœ¨ã®èª¿åæƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã¾ã™ã€‚
       * ä¾‹: { major: 'Cãƒ¡ã‚¸ãƒ£ãƒ¼', minor: 'Aãƒã‚¤ãƒŠãƒ¼' }
       * @returns {object} ç¾åœ¨ã®èª¿åæƒ…å ±
       */
      getCurrentKeyNameInfo() {
          return this.keyDataBySignature[this.currentKeySignature];
      }

      /**
       * ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹èª¿åæ–‡å­—åˆ—ï¼ˆä¾‹: 'Cãƒ¡ã‚¸ãƒ£ãƒ¼ / Aãƒã‚¤ãƒŠãƒ¼'ï¼‰ã‚’è¿”ã—ã¾ã™ã€‚
       * @returns {string} ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹èª¿åæ–‡å­—åˆ—
       */
      getCurrentKeyNameString() {
          const info = this.keyDataBySignature[this.currentKeySignature];
          return `${info.major} / ${info.minor}`;
      }

      /**
       * SVGè¡¨ç¤ºé ˜åŸŸã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
       * @param {boolean} isVisible - trueã§è¡¨ç¤ºã€falseã§éè¡¨ç¤º
       */
      setSvgDisplayVisibility(isVisible) {
          if (this.svgDisplay) {
              this.svgDisplay.classList.toggle('hidden', !isVisible);
          }
      }

      /**
       * ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ï¼ˆâ™­/â™¯ãƒœã‚¿ãƒ³ã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã€ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ¬„ï¼‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
       * @param {boolean} isVisible - trueã§è¡¨ç¤ºã€falseã§éè¡¨ç¤º
       */
      setControlPanelVisibility(isVisible) {
          if (this.controlPanel) {
              this.controlPanel.classList.toggle('hidden', !isVisible);
          }
      }

      /**
       * ç¾åœ¨ã®èª¿å·ãƒ»èª¿åæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
       * @param {boolean} isVisible - trueã§è¡¨ç¤ºã€falseã§éè¡¨ç¤º
       */
      setCurrentKeyInfoVisibility(isVisible) {
          if (this.currentKeyInfoDiv) {
              this.currentKeyInfoDiv.classList.toggle('hidden', !isVisible);
          }
      }

      /**
       * æ•°å€¤ã§èª¿å·ã‚’æŒ‡å®šã—ã€UIã‚’æ›´æ–°ã—ã¾ã™ã€‚
       * @param {number} signatureNumber - è¨­å®šã™ã‚‹èª¿å·ã®æ•°å€¤ (-7 ã‹ã‚‰ +7)
       * @returns {Promise<void>} UIã®æ›´æ–°ãŒå®Œäº†ã—ãŸã¨ãã«è§£æ±ºã•ã‚Œã‚‹Promise
       */
      async setKeyBySignatureNumber(signatureNumber) {
          if (signatureNumber >= -7 && signatureNumber <= 7) {
              this.currentKeySignature = signatureNumber;
              await this.render();
          } else {
              console.error(`KscKeySignatureController (ID: ${this.rootElement.id}): ç„¡åŠ¹ãªèª¿å·æ•°å€¤: ${signatureNumber}`);
          }
      }

      /**
       * èª¿åæ–‡å­—åˆ—ï¼ˆä¾‹: 'Cãƒ¡ã‚¸ãƒ£ãƒ¼' ã¾ãŸã¯ 'Aãƒã‚¤ãƒŠãƒ¼'ï¼‰ã‚’æŒ‡å®šã—ã€UIã‚’æ›´æ–°ã—ã¾ã™ã€‚
       * @param {string} keyNameString - è¨­å®šã™ã‚‹èª¿åæ–‡å­—åˆ—
       * @returns {Promise<void>} UIã®æ›´æ–°ãŒå®Œäº†ã—ãŸã¨ãã«è§£æ±ºã•ã‚Œã‚‹Promise
       */
      async setKeyByNameString(keyNameString) {
          const data = this.keyDataByName[keyNameString.trim()];
          if (data) {
              this.currentKeySignature = data.signature;
              await this.render();
          } else {
              console.error(`KscKeySignatureController (ID: ${this.rootElement.id}): å¯¾å¿œã™ã‚‹èª¿åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: '${keyNameString}'`);
          }
      }
    }

    // --- ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–å‡¦ç† ---
    const controllers = {}; // å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ ¼ç´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

    window.addEventListener('load', async () => {
      const globalStatusMessage = document.getElementById('globalStatusMessage');

      // å…¨ã¦ã® .smc-key-signature ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¦ç´ ã‚’å–å¾—
      const keySelectorElements = document.querySelectorAll('.smc-key-signature');

      for (const element of keySelectorElements) {
        // å„è¦ç´ ã«å¯¾ã—ã¦æ–°ã—ã„ KscKeySignatureController ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        const controller = new KscKeySignatureController(element);
        controllers[element.id] = controller; // IDã‚’ã‚­ãƒ¼ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜

        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’åˆæœŸåŒ–
        await controller.initialize();
      }

      // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«æ“ä½œãƒ‡ãƒ¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
      document.getElementById('setKeySelector1ToDMinor').addEventListener('click', async () => {
          await controllers['keySelector1'].setKeyByNameString('Dãƒã‚¤ãƒŠãƒ¼');
          globalStatusMessage.textContent = 'ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ1ã‚’Dãƒã‚¤ãƒŠãƒ¼ã«è¨­å®šã—ã¾ã—ãŸã€‚';
      });

      document.getElementById('setKeySelector2ToEFlatMajor').addEventListener('click', async () => {
          await controllers['keySelector2'].setKeyByNameString('Eâ™­ãƒ¡ã‚¸ãƒ£ãƒ¼');
          globalStatusMessage.textContent = 'ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ2ã‚’Eâ™­ãƒ¡ã‚¸ãƒ£ãƒ¼ã«è¨­å®šã—ã¾ã—ãŸã€‚';
      });

      document.getElementById('getSelector1Info').addEventListener('click', () => {
          const controller1 = controllers['keySelector1'];
          console.log('--- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ1ã®ç¾åœ¨ã®èª¿å·ãƒ»èª¿åæƒ…å ± ---');
          console.log('æ•°å€¤:', controller1.getCurrentKeySignatureNumber());
          console.log('è¨˜å·:', controller1.getCurrentKeySignatureAccidString());
          console.log('èª¿åã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:', controller1.getCurrentKeyNameInfo());
          console.log('è¡¨ç¤ºæ–‡å­—åˆ—:', controller1.getCurrentKeyNameString());
          globalStatusMessage.textContent = 'ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ1ã®æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸã€‚';
      });

      let selector2ControlsVisible = controllers['keySelector2'].initialControlsDisplay; // åˆæœŸçŠ¶æ…‹ã‚’å–å¾—
      document.getElementById('toggleSelector2Controls').addEventListener('click', () => {
          selector2ControlsVisible = !selector2ControlsVisible;
          controllers['keySelector2'].setControlPanelVisibility(selector2ControlsVisible);
          globalStatusMessage.textContent = `ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ2ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’${selector2ControlsVisible ? 'è¡¨ç¤º' : 'éè¡¨ç¤º'}ã«ã—ã¾ã—ãŸã€‚`;
      });

      globalStatusMessage.textContent = 'ãƒšãƒ¼ã‚¸ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚';
    });
  </script>

</body></html>