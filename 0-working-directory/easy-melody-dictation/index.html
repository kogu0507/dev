<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Melody Dictation</title>
    <style>
        .button-group {
            display: flex;
            gap: 10px;
        }

        /* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-button.is-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>

    <header>
        <h1><!-- æœ€çµ‚çš„ã«ã¯ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¹ã«ç§»è¡Œã™ã‚‹ã®ã§ä¸è¦ --></h1>
    </header>

    <main>
        <section id="data">
            <script id="ezmelo-json-data" type="application/json">
                [
                    {
                        "id": "001",
                        "meiURL": "./melody-dictation-001.mei",
                        "exerciseInfo": "æ—‹å¾‹è´éŸ³ ãƒé•·èª¿ 4/4æ‹å­ 4å°ç¯€",
                        "tonicChordSpec": { "notes": ["C4","E4","G4"] },
                        "playbackDef": [
                            { "range": "1-2", "interval": 5 },
                            { "range": "2-3", "interval": 10 }
                        ],
                        "endBellSpec": { "bellId": "endBell1" }
                    },
                    {
                        "id": "002",
                        "meiURL": "./melody-dictation-002.mei",
                        "exerciseInfo": "æ—‹å¾‹è´éŸ³ ãƒé•·èª¿ 4/4æ‹å­ 8å°ç¯€",
                        "tonicChordSpec": { "notes": ["C4","E4","G4"] },
                        "playbackDef": [
                            { "range": "5-6", "interval": 3 }
                        ],
                        "endBellSpec": { "bellId": "endBell1" }
                    }
                ]
            </script>
        </section>

        <!-- ã‚«ã‚¹ã‚¿ãƒ HTML 1 -->
        <section id="tab-ui">
            <link rel="stylesheet"
                href="https://cdn.jsdelivr.net/gh/kogu0507/module@v2.7.0/components/simple-tab-component/style.min.css" />
            <script
                src="https://cdn.jsdelivr.net/gh/kogu0507/module@v2.7.0/components/simple-tab-component/script.min.js"></script>

            <div class="simple-tab-component-container" data-default-tab="exercise-selection" data-deep-link="true">
                <div class="tabs">
                    <button class="tab-button" data-tab="exercise-selection">èª²é¡Œé¸æŠ</button>
                    <button class="tab-button" data-tab="exercise">èª²é¡Œ</button>
                    <button class="tab-button" data-tab="answer">è§£ç­”</button>
                    <button class="tab-button" data-tab="settings">è¨­å®š</button>
                </div>

                <div class="tab-content">
                    <div id="exercise-selection" class="tab-pane">
                        <h3 style="display:none;">èª²é¡Œé¸æŠ</h3>
                        <section class="ezmelo-exercise-selection-section">
                            JSONã‹ã‚‰èª²é¡Œã‚’èª­è¾¼ä¸­...
                        </section>
                    </div>

                    <div id="exercise" class="tab-pane">
                        <h3 style="display:none;">èª²é¡Œ</h3>

                        <section class="ezmelo-exercise-section">
                            <h4>èª²é¡Œæƒ…å ±</h4>
                            <div class="ezmelo-exercise-info">èª²é¡Œæƒ…å ±ã‚’èª­è¾¼ä¸­...</div>
                            <div class="ezmelo-playback-info">ãƒ—ãƒ¬ã‚¤ãƒãƒƒã‚¯æƒ…å ±ã‚’èª­è¾¼ä¸­...</div>
                        </section>


                        <h4>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h4>
                        <section class="ezmelo-player-section" id="exercise-player-section"
                            data-template-id="ezmelo-player-template">
                            ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼èª­è¾¼ä¸­...
                        </section>

                        <h4>ç°¡æ˜“ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰</h4>
                        <section class="ezmelo-keyboard-section" id="exercise-keyboard-section"
                            data-template-id="ezmelo-keyboard-template">
                            ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰èª­è¾¼ä¸­...
                        </section>

                    </div>

                    <div id="answer" class="tab-pane">
                        <h3 style="display:none;">è§£ç­”</h3>
                        <h4>è§£ç­”ç”»åƒ</h4>
                        <section class="ezmelo-answer-display">
                            <div class="score-container" id="answer-score-container">
                                è§£ç­”æ¥½è­œã‚’èª­è¾¼ä¸­...
                            </div>
                        </section>

                        <h4>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h4>
                        <section class="ezmelo-player-section" id="answer-player-section"
                            data-template-id="ezmelo-player-template">
                            ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼èª­è¾¼ä¸­...
                        </section>

                        <h4>ç°¡æ˜“ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰</h4>
                        <section class="ezmelo-keyboard-section" id="answer-keyboard-section"
                            data-template-id="ezmelo-keyboard-template">
                            ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰èª­è¾¼ä¸­...
                        </section>
                    </div>

                    <div id="settings" class="tab-pane">
                        <h3 style="display:none;">è¨­å®š</h3>
                        <section class="ezmelo-player-setting-section">
                            <p>ï¼ˆå°†æ¥ç”¨è¨­å®šUIã‚’ã“ã“ã«ï¼‰</p>
                        </section>
                        <section class="ezmelo-playlist-setting-section">
                            <p>ï¼ˆplaybackDefç·¨é›†UIã‚’ä½œã‚‹ãªã‚‰ã“ã“ã«ï¼‰</p>
                        </section>
                    </div>
                </div>
            </div>

            <section id="template-section">
                <template id="ezmelo-player-template">
                    <div class="ezmelo-control-buttons">
                        <div class="ezmelo-playback-status" data-role="status" aria-live="polite">
                            ğŸ§ å†ç”Ÿã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                        </div>
                        <div class="button-group">
                            <button class="ezmelo-control-button" data-role="start-playlist">è©¦é¨“å†ç”Ÿ</button>
                            <button class="ezmelo-control-button" data-role="stop">åœæ­¢</button>
                            <button class="ezmelo-control-button" data-role="mute">ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
                        </div>
                        <div class="ezmelo-play-range" data-player-mode="practice">
                            <select id="play-range-select">
                                <option value="1-1" data-start-measure="1" data-end-measure="1">1å°ç¯€ç›®</option>
                                <option value="1-1" data-start-measure="2" data-end-measure="2">2å°ç¯€ç›®</option>
                                <option value="1-1" data-start-measure="3" data-end-measure="3">3å°ç¯€ç›®</option>
                                <option value="1-1" data-start-measure="4" data-end-measure="4">4å°ç¯€ç›®</option>
                                <option>---</option>
                                <option value="1-2" data-start-measure="1" data-end-measure="2">1-2å°ç¯€</option>
                                <option value="3-4" data-start-measure="3" data-end-measure="4">3-4å°ç¯€</option>
                                <option>---</option>
                                <option value="1-4" data-start-measure="1" data-end-measure="4">1-4å°ç¯€</option>
                            </select>
                            <button class="ezmelo-control-button" data-role="play-range">æŒ‡å®šç¯„å›²å†ç”Ÿ</button>
                        </div>
                        <label style="display:flex; align-items:center; gap:4px;">
                            Vol:
                            <input type="range" data-role="volume" min="0" max="100" value="50" />
                        </label>
                    </div>



                </template>

                <template id="ezmelo-keyboard-template">
                    <link rel="stylesheet"
                        href="https://cdn.jsdelivr.net/gh/kogu0507/module@v2.8.0/components/simple-synth-mini/style.min.css">
                    <style>

                    </style>
                    <section class="ssm-demo-section">
                        <div class="ssm-simple-synth-mini" data-volume-slider="true" data-octaves="2"
                            data-start-note="C4" data-sound-enabled="true" data-instrument="sine"
                            data-show-note-labels="false">
                            <div class="ssm-keyboard-wrapper">
                            </div>
                        </div>
                    </section>
                    <script type="module" defer>
                        // TOOD: é–‹ç™ºä¸­ã¯module@mainã§ã‚ˆã„ã‹
                        import { SimpleSynthMini } from 'https://cdn.jsdelivr.net/gh/kogu0507/module@main/components/simple-synth-mini/script.min.js';

                        // querySelectorAll ã‚’ä½¿ç”¨ã—ã¦ã€ã™ã¹ã¦ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¦ç´ ã‚’å–å¾—
                        const synthElements = document.querySelectorAll('.ssm-simple-synth-mini');

                        synthElements.forEach(synthElement => {
                            if (synthElement) {
                                if (!synthElement.id) {
                                    synthElement.id = `ssm-${Math.random().toString(36).slice(2)}`;
                                }
                                new SimpleSynthMini(synthElement);
                            }
                        });


                    </script>
                </template>


            </section>
        </section>
    </main>

    <script type="module" defer>
        import { VerovioManager } from 'https://cdn.jsdelivr.net/gh/kogu0507/module@main/verovio/verovio-manager.min.js';
        import { TonejsManager } from 'https://cdn.jsdelivr.net/gh/kogu0507/module@main/tonejs/manager/tonejs-manager.js';

        const verovioManager = new VerovioManager();
        const tonejsManager = new TonejsManager();

        function loadTemplate() {
            // data-template-id å±æ€§ã‚’æŒã¤ã™ã¹ã¦ã®è¦ç´ ã‚’å–å¾—
            const sectionsToPopulate = document.querySelectorAll('[data-template-id]');

            sectionsToPopulate.forEach(section => {
                const templateId = section.dataset.templateId; // data-template-idã®å€¤ã‚’å–å¾—

                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¦ç´ ã‚’å–å¾—
                const template = document.getElementById(templateId);

                if (template) {
                    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å†…å®¹ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
                    const clonedContent = template.content.cloneNode(true);

                    // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸå†…å®¹ã‚’æŒ¿å…¥
                    section.innerHTML = '';
                    section.appendChild(clonedContent);
                } else {
                    console.warn(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID "${templateId}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
                }
            });

            // è¡¨ç¤ºï¼éè¡¨ç¤ºã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’çŸ¥ã‚‰ã›ã‚‹
            document.dispatchEvent(new CustomEvent('templatesLoaded'));
        }

        function initializeEventListeners(){
            /* 
            èª²é¡Œ ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸ
            */
        }

        async function displayAnswerScore(meiUrl, targetElementId) {
            console.log('æ¥½è­œã®è¡¨ç¤ºã‚’é–‹å§‹ã—ã¾ã™...');
            await verovioManager.displaySvgFromUrl(meiUrl, targetElementId);
            console.log('æ¥½è­œã®è¡¨ç¤ºãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
        }

        async function initialize() {
            // TODO: promise.allã¨ã‹ï¼Ÿ
            try {
                loadTemplate();
                initializeEventListeners(elements);

                console.log('VerovioManager ã®åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™...');
                await verovioManager.initialize();
                console.log('åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                /*
                promis.allã§
                Verovioãƒ­ãƒ¼ãƒ‰
                Tonejsã‚’ãƒ­ãƒ¼ãƒ‰
                */
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯ VerovioManager å†…éƒ¨ã§UIè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ãŒã€
                // ã“ã“ã§ã‚‚å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®å‡¦ç†ãŒã§ãã¾ã™ã€‚
            }
        }
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
    <!--
    template-loader.js: 
        HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã® template ã‚¿ã‚°ã§å®šç¾©ã•ã‚ŒãŸå†…å®¹ã‚’ã€æŒ‡å®šã•ã‚ŒãŸå ´æ‰€ã«è‡ªå‹•çš„ã«èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã™ã‚‹ 
    toggle-visibility.js
        ç‰¹å®šã®ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«ã€åˆ¥ã®è¦ç´ ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        
    -->
    <!-- <script defer src="./template-loader.js"></script> -->
    <script defer src="./toggle-visibility.js"></script>
    <script defer type="module" src="./app.js"></script>

</body>

</html>