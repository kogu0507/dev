<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Melody Dictation</title>
    <style>
        .button-group {
            display: flex;
            gap: 10px;
        }

        /* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-button.is-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>

    <header>
        <h1><!-- æœ€çµ‚çš„ã«ã¯ãƒ¯ãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¹ã«ç§»è¡Œã™ã‚‹ã®ã§ä¸è¦ --></h1>
    </header>

    <main>
        <section id="data">
            <script id="ezmelo-json-data" type="application/json">
                [
                    {
                        "id": "001",
                        "meiURL": "./melody-dictation-001.mei",
                        "exerciseInfo": "æ—‹å¾‹è´éŸ³ ãƒé•·èª¿ 4/4æ‹å­ 4å°ç¯€",
                        "tonicChordSpec": { "notes": ["C4","E4","G4"] },
                        "playbackDef": [
                            { "range": "1-2", "interval": 5 },
                            { "range": "2-3", "interval": 10 }
                        ],
                        "endBellSpec": { "bellId": "endBell1" }
                    },
                    {
                        "id": "002",
                        "meiURL": "./melody-dictation-002.mei",
                        "exerciseInfo": "æ—‹å¾‹è´éŸ³ ãƒé•·èª¿ 4/4æ‹å­ 8å°ç¯€",
                        "tonicChordSpec": { "notes": ["C4","E4","G4"] },
                        "playbackDef": [
                            { "range": "5-6", "interval": 3 }
                        ],
                        "endBellSpec": { "bellId": "endBell1" }
                    }
                ]
            </script>
        </section>

        <!-- ã‚«ã‚¹ã‚¿ãƒ HTML 1 -->
        <section id="tab-ui">
            <link rel="stylesheet"
                href="https://cdn.jsdelivr.net/gh/kogu0507/module@main/components/simple-tab-component/style.min.css" />
            <script
                src="https://cdn.jsdelivr.net/gh/kogu0507/module@main/components/simple-tab-component/script.min.js"></script>

            <div class="simple-tab-component-container" data-default-tab="exercise-selection" data-deep-link="true">
                <div class="tabs">
                    <button class="tab-button" data-tab="exercise-selection">èª²é¡Œé¸æŠ</button>
                    <button class="tab-button" data-tab="exercise">èª²é¡Œ</button>
                    <button class="tab-button" data-tab="answer">è§£ç­”</button>
                    <button class="tab-button" data-tab="settings">è¨­å®š</button>
                </div>

                <div class="tab-content">
                    <div id="exercise-selection" class="tab-pane">
                        <h3 style="display:none;">èª²é¡Œé¸æŠ</h3>
                        <section class="ezmelo-exercise-selection-section">
                            JSONã‹ã‚‰èª²é¡Œã‚’èª­è¾¼ä¸­...
                        </section>
                    </div>

                    <div id="exercise" class="tab-pane">
                        <h3 style="display:none;">èª²é¡Œ</h3>

                        <section class="ezmelo-exercise-section">
                            <h4>èª²é¡Œæƒ…å ±</h4>
                            <div class="ezmelo-exercise-info" id="ezmelo-exercise-info">èª²é¡Œæƒ…å ±ã‚’èª­è¾¼ä¸­...</div>
                            <div class="ezmelo-playback-info" id="ezmelo-playback-info">ãƒ—ãƒ¬ã‚¤ãƒãƒƒã‚¯æƒ…å ±ã‚’èª­è¾¼ä¸­...</div>
                        </section>


                        <h4>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h4>
                        <section class="ezmelo-player-section" id="exercise-player-section"
                            data-template-id="ezmelo-player-template">
                            ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼èª­è¾¼ä¸­...
                        </section>

                        <h4>ç°¡æ˜“ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰</h4>
                        <section class="ezmelo-keyboard-section" id="exercise-keyboard-section"
                            data-template-id="ezmelo-keyboard-template">
                            ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰èª­è¾¼ä¸­...
                        </section>

                    </div>

                    <div id="answer" class="tab-pane">
                        <h3 style="display:none;">è§£ç­”</h3>
                        <h4>è§£ç­”ç”»åƒ</h4>
                        <section class="ezmelo-answer-display">
                            <div class="score-container" id="answer-score-container">
                                è§£ç­”æ¥½è­œã‚’èª­è¾¼ä¸­...
                            </div>
                        </section>

                        <h4>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h4>
                        <section class="ezmelo-player-section" id="answer-player-section"
                            data-template-id="ezmelo-player-template">
                            ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼èª­è¾¼ä¸­...
                        </section>

                        <h4>ç°¡æ˜“ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰</h4>
                        <section class="ezmelo-keyboard-section" id="answer-keyboard-section"
                            data-template-id="ezmelo-keyboard-template">
                            ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰èª­è¾¼ä¸­...
                        </section>
                    </div>

                    <div id="settings" class="tab-pane">
                        <h3 style="display:none;">è¨­å®š</h3>
                        <section class="ezmelo-player-setting-section">
                            <p>ï¼ˆå°†æ¥ç”¨è¨­å®šUIã‚’ã“ã“ã«ï¼‰</p>
                        </section>
                        <section class="ezmelo-playlist-setting-section">
                            <p>ï¼ˆplaybackDefç·¨é›†UIã‚’ä½œã‚‹ãªã‚‰ã“ã“ã«ï¼‰</p>
                        </section>
                    </div>
                </div>
            </div>

            <section id="template-section">
                <template id="ezmelo-player-template">
                    <div class="ezmelo-control-buttons">
                        <div class="ezmelo-playback-status" data-role="status" aria-live="polite">
                            ğŸ§ å†ç”Ÿã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                        </div>
                        <div class="button-group">
                            <button class="ezmelo-control-button" data-role="start-playlist">è©¦é¨“å†ç”Ÿ</button>
                            <button class="ezmelo-control-button" data-role="stop">åœæ­¢</button>
                            <button class="ezmelo-control-button" data-role="mute">ãƒŸãƒ¥ãƒ¼ãƒˆ</button>
                        </div>
                        <div class="ezmelo-play-range" data-player-mode="practice">
                            <select id="play-range-select">
                                <option value="1-1" data-start-measure="1" data-end-measure="1">1å°ç¯€ç›®</option>
                                <option value="1-1" data-start-measure="2" data-end-measure="2">2å°ç¯€ç›®</option>
                                <option value="1-1" data-start-measure="3" data-end-measure="3">3å°ç¯€ç›®</option>
                                <option value="1-1" data-start-measure="4" data-end-measure="4">4å°ç¯€ç›®</option>
                                <option>---</option>
                                <option value="1-2" data-start-measure="1" data-end-measure="2">1-2å°ç¯€</option>
                                <option value="3-4" data-start-measure="3" data-end-measure="4">3-4å°ç¯€</option>
                                <option>---</option>
                                <option value="1-4" data-start-measure="1" data-end-measure="4">1-4å°ç¯€</option>
                            </select>
                            <button class="ezmelo-control-button" data-role="play-range">æŒ‡å®šç¯„å›²å†ç”Ÿ</button>
                        </div>
                        <label style="display:flex; align-items:center; gap:4px;">
                            Vol:
                            <input type="range" data-role="volume" min="0" max="100" value="50" />
                        </label>
                    </div>



                </template>

                <template id="ezmelo-keyboard-template">
                    <link rel="stylesheet"
                        href="https://cdn.jsdelivr.net/gh/kogu0507/module@v2.8.0/components/simple-synth-mini/style.min.css">
                    <style>

                    </style>



                    <section class="ssm-demo-section">
                        <div class="ssm-simple-synth-mini" data-volume-slider="true" data-octaves="2"
                            data-start-note="C4" data-sound-enabled="true" data-instrument="sine"
                            data-show-note-labels="false">
                            <div class="ssm-keyboard-wrapper">
                            </div>
                        </div>
                    </section>
                    <script type="module" defer>
                        // TOOD: é–‹ç™ºä¸­ã¯module@mainã§ã‚ˆã„ã‹
                        import { SimpleSynthMini } from 'https://cdn.jsdelivr.net/gh/kogu0507/module@main/components/simple-synth-mini/script.min.js';

                        // querySelectorAll ã‚’ä½¿ç”¨ã—ã¦ã€ã™ã¹ã¦ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¦ç´ ã‚’å–å¾—
                        const synthElements = document.querySelectorAll('.ssm-simple-synth-mini');

                        synthElements.forEach(synthElement => {
                            if (synthElement) {
                                if (!synthElement.id) {
                                    synthElement.id = `ssm-${Math.random().toString(36).slice(2)}`;
                                }
                                new SimpleSynthMini(synthElement);
                            }
                        });
                    </script>
                </template>
            </section>
        </section>
    </main>

    <script defer>
        // å®Œæˆã—ãŸã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã€‚é–‹ç™ºä¸­ã¯ã“ã“ã§ã¤ãã‚‹
        class UIManager {
            constructor(verovioManager, ids) {
                this.verovioManager = verovioManager;
                this.ids = ids;
                this.elements = {};
            }

            async initialize() {
                try {
                    // Verovioã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
                    const verOptions = {
                        svgViewBox: true,
                        adjustPageHeight: true,
                        pageWidth: 2100,
                        breaks: "encoded",
                        spacingStaff: 5,
                        spacingSystem: 15,
                        footer: "none",
                        pageMarginTop: 0,
                        pageMarginRight: 10,
                        pageMarginBottom: 0,
                        pageMarginLeft: 10,
                        minLastJustification: 0,
                    };
                    if (this.verovioManager) {
                        this.verovioManager.setRenderOptions(verOptions);
                        console.log("[ezmelo] verovio: render options set");
                    } else {
                        console.warn("[ezmelo] verovio: VerovioManager not initialized.");
                    }

                    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å…ˆã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
                    this.loadTemplate();
                    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã‚ˆã£ã¦è¿½åŠ ã•ã‚ŒãŸè¦ç´ ã‚‚å«ã‚ã¦å–å¾—
                    this.getElementsFromIds();
                    this.getElementsFromDataRoles();
                    this.initializeEventListeners();
                    console.log('UIã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                } catch (error) {
                    console.error('UIã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                }
            }


            /**
            * data-template-id å±æ€§ã‚’æŒã¤è¦ç´ ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æŒ¿å…¥
            */
            loadTemplate() {
                const sectionsToPopulate = document.querySelectorAll('[data-template-id]');
                sectionsToPopulate.forEach(section => {
                    const templateId = section.dataset.templateId;
                    const template = document.getElementById(templateId);
                    if (template) {
                        const clonedContent = template.content.cloneNode(true);
                        section.innerHTML = '';
                        section.appendChild(clonedContent);
                    } else {
                        console.warn(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID "${templateId}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
                    }
                });

                document.dispatchEvent(new CustomEvent('templatesLoaded'));
            }


            /**
            * this.ids ã«å®šç¾©ã•ã‚ŒãŸIDã‚’ä½¿ã£ã¦DOMè¦ç´ ã‚’å–å¾—ã—ã€this.elements ã«æ ¼ç´ã™ã‚‹
            */
            getElementsFromIds() {
                for (const key in this.ids) {
                    const elementId = this.ids[key];
                    const element = document.getElementById(elementId);
                    if (element) {
                        this.elements[key] = element;
                    } else {
                        console.warn(`è­¦å‘Š: ID "${elementId}" ã‚’æŒã¤è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚­ãƒ¼ã¯ "${key}" ã§ã™ã€‚`);
                    }
                }
            }


            /**
            * data-role å±æ€§ã‚’æŒã¤è¦ç´ ã‚’å–å¾—ã—ã€this.elements ã«æ ¼ç´ã™ã‚‹
            */
            getElementsFromDataRoles() {
                const players = [this.elements.exercisePlayerSection, this.elements.answerPlayerSection];
                players.forEach((player, index) => {
                    if (!player) return;

                    const playerType = index === 0 ? 'exercise' : 'answer';

                    // å†ç”Ÿãƒœã‚¿ãƒ³
                    const playButton = player.querySelector('[data-role="start-playlist"]');
                    if (playButton) this.elements[`${playerType}PlayButton`] = playButton;

                    // åœæ­¢ãƒœã‚¿ãƒ³
                    const stopButton = player.querySelector('[data-role="stop"]');
                    if (stopButton) this.elements[`${playerType}StopButton`] = stopButton;

                    // ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³
                    const muteButton = player.querySelector('[data-role="mute"]');
                    if (muteButton) this.elements[`${playerType}MuteButton`] = muteButton;

                    // ãƒ—ãƒ¬ã‚¤ãƒãƒƒã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                    const statusDisplay = player.querySelector('[data-role="status"]');
                    if (statusDisplay) this.elements[`${playerType}StatusDisplay`] = statusDisplay;
                });

                // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚‚ã“ã“ã§å–å¾—å¯èƒ½
                const tabButtons = document.querySelectorAll('.tab-button');
                if (tabButtons) {
                    this.elements.tabButtons = tabButtons;
                }
            }


            initializeEventListeners() {
                // UIè¦ç´ ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                const players = ['exercise', 'answer'];
                players.forEach(playerType => {
                    if (this.elements[`${playerType}PlayButton`]) {
                        this.elements[`${playerType}PlayButton`].addEventListener('click', () => {
                            document.dispatchEvent(new CustomEvent('playButtonClicked', { detail: playerType }));
                        });
                    }
                    if (this.elements[`${playerType}StopButton`]) {
                        this.elements[`${playerType}StopButton`].addEventListener('click', () => {
                            document.dispatchEvent(new CustomEvent('stopButtonClicked', { detail: playerType }));
                        });
                    }
                });

                // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚‚ã“ã“ã«çµ±ä¸€
                if (this.elements.tabButtons) {
                    this.elements.tabButtons.forEach(button => {
                        button.addEventListener('click', (event) => {
                            const tabId = event.target.dataset.tab;
                            document.dispatchEvent(new CustomEvent('tabChanged', { detail: tabId }));
                        });
                    });
                }


            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
            updatePlayerState(playerType, isPlaying) {
                const playButton = this.elements[`${playerType}PlayButton`];
                const stopButton = this.elements[`${playerType}StopButton`];
                if (playButton && stopButton) {
                    playButton.disabled = isPlaying;
                    stopButton.disabled = !isPlaying;
                }
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
            updatePlayerStatus(playerType, message) {
                const statusDisplay = this.elements[`${playerType}StatusDisplay`];
                if (statusDisplay) {
                    statusDisplay.textContent = message;
                }
            }

            /**
            * æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠã«MEIãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦SVGã‚’æç”»
            * @param {string} meiUrl - MEIãƒ•ã‚¡ã‚¤ãƒ«ã®URL
            * @param {string} containerId - SVGã‚’æç”»ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®ID
            */
            async loadAndDisplayScore(meiUrl, containerId) {
                if (!this.verovioManager) {
                    console.error("[ezmelo] verovio: VerovioManagerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                    return;
                }
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = 'æ¥½è­œã‚’èª­ã¿è¾¼ã¿ä¸­...';
                    try {
                        await this.verovioManager.displaySvgFromUrl(meiUrl, containerId);
                    } catch (error) {
                        console.error(`[ezmelo] verovio: æ¥½è­œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`, error);
                        container.innerHTML = 'æ¥½è­œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    }
                } else {
                    console.error(`[ezmelo] verovio: æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠID "${containerId}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
                }
            }

            /**
                 * æŒ‡å®šã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã¾ãŸã¯ç„¡åŠ¹ã«ã™ã‚‹
                 * @param {string} buttonName - this.elementsã®ã‚­ãƒ¼å (ä¾‹: 'playButton')
                 * @param {boolean} enable - trueã§æœ‰åŠ¹ã€falseã§ç„¡åŠ¹
                 */
            toggleButtonState(buttonName, enable) {
                const button = this.elements[buttonName];
                if (button) {
                    button.disabled = !enable;
                    // ... ãã®ä»–ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´ãªã© ...
                }
            }


            // playButtonã¨stopButtonã®çŠ¶æ…‹ã‚’ã¾ã¨ã‚ã¦æ›´æ–°ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
            updatePlayButtonState(isPlaying) {
                // å†ç”Ÿä¸­ã¯å†ç”Ÿãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã€åœæ­¢ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                this.toggleButtonState('playButton', !isPlaying);
                this.toggleButtonState('stopButton', isPlaying);
            }

            formatExerciseInfo(info) {
                return `<h4>${info}</h4>`;
            }

            formatPlaybackInfo(defs) {
                if (!defs?.length) {
                    return '<span class="no-playback-data-text">ãƒ—ãƒ¬ã‚¤ãƒãƒƒã‚¯æƒ…å ±: ãªã—</span>';
                }
                const rows = defs.map((d, i) => `
                <tr><td>${i + 1}</td><td>${d.range}</td><td>${d.interval}</td></tr>
            `).join("");
                return `
                <table class="playback-table">
                <thead><tr><th>#</th><th>å†ç”Ÿç¯„å›²</th><th>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼ˆç§’ï¼‰</th></tr></thead>
                <tbody>${rows}</tbody>
                </table>
            `.trim();
            }
        }


        class EasyMelodyDictationApp {
            constructor(uiManager, verovioManager, tonejsManager) {
                this.uiManager = uiManager;
                this.verovioManager = verovioManager;
                this.tonejsManager = tonejsManager;
                this.currentExercise = null;
            }

            async initialize() {
                try {
                    console.log('VerovioManagerã®åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™...');
                    await this.verovioManager.initialize();
                    console.log('åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');

                    await this.uiManager.initialize();
                    this.initializeEventListeners();
                    this.loadExercises();
                    this.renderExerciseButtons();
                } catch (error) {
                    console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                }
            }



            /**
             * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹
             */
            initializeEventListeners() {
                // å†ç”Ÿãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ã€ã©ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ã§ã‚‚å…±é€šã®playãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™
                document.addEventListener('playButtonClicked', async (event) => {
                    const playerType = event.detail;
                    this.play(playerType);
                });

                // åœæ­¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ã€ã©ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ã§ã‚‚å…±é€šã®stopãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™
                document.addEventListener('stopButtonClicked', (event) => {
                    this.stop(event.detail);
                });

                document.addEventListener('tabChanged', async (event) => {
                    const tabId = event.detail;
                    if (tabId === this.uiManager.ids.tabPaneAnswer && this.currentExercise) {
                        // è§£ç­”ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚‰æ¥½è­œã‚’æç”»
                        this.uiManager.loadAndDisplayScore(this.currentExercise.meiURL, this.uiManager.ids.answerScoreContainer);
                    }
                });
            }

            loadExercises() {
                const jsonEl = document.getElementById(this.uiManager.ids.jsonData);
                if (jsonEl) {
                    this.exercises = JSON.parse(jsonEl.textContent.trim());
                    console.log("[ezmelo] exercises loaded:", this.exercises);
                } else {
                    console.error("èª²é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    this.exercises = [];
                }
            }

            renderExerciseButtons() {
                const selSec = document.querySelector(".ezmelo-exercise-selection-section");
                if (!selSec) return;
                selSec.innerHTML = "";
                if (this.exercises.length === 0) {
                    selSec.textContent = "èª²é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
                    return;
                }
                this.exercises.forEach(ex => {
                    const btn = document.createElement("button");
                    btn.textContent = `${ex.id}ï¼š${ex.exerciseInfo}`;
                    btn.addEventListener("click", () => this.onSelectExercise(ex));
                    selSec.appendChild(btn);
                });
            }

            async onSelectExercise(exercise) {
                this.currentExercise = exercise;
                console.log("[ezmelo] selected exercise:", exercise);

                // UIã«èª²é¡Œæƒ…å ±ã‚’è¡¨ç¤º
                const infoHtml = this.uiManager.formatExerciseInfo(exercise.exerciseInfo);
                const playbackHtml = this.uiManager.formatPlaybackInfo(exercise.playbackDef);
                const exerciseInfoEl = document.getElementById(this.uiManager.ids.exerciseInfo);
                const playbackInfoEl = document.getElementById(this.uiManager.ids.playbackInfo);

                if (exerciseInfoEl) exerciseInfoEl.innerHTML = infoHtml;
                if (playbackInfoEl) playbackInfoEl.innerHTML = playbackHtml;

                // èª²é¡Œç”»é¢ã«æ¥½è­œã‚’æç”»
                this.uiManager.updatePlayerStatus('exercise', 'æ¥½è­œã¨MIDIãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ä¸­...');
                await Promise.all([
                    // æ¥½è­œã®è¡¨ç¤º
                    //this.uiManager.loadAndDisplayScore(exercise.meiURL, 'exercise-score-container'),
                    // MIDIãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰
                    this.loadMidiForPlayback(exercise)
                ]);
                this.uiManager.updatePlayerStatus('exercise', 'âœ“ æº–å‚™å®Œäº†');
            }



            // å†ç”Ÿç”¨ã®MIDIãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€å°‚ç”¨ãƒ¡ã‚½ãƒƒãƒ‰
            async loadMidiForPlayback(exercise) {
                const midiData = await this.verovioManager.getMidiFromMei(exercise.meiURL);
                await this.tonejsManager.loadFromVerovio(midiData);
            }

            async play(playerType) {
                if (!this.currentExercise) return;

                if (!this.tonejsManager.isSetup) {
                    await this.tonejsManager.setup({
                        onPlayStart: () => this.handlePlaybackStart(),
                        onPlayEnd: () => this.handlePlaybackEnd()
                    });
                    this.tonejsManager.isSetup = true; // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¸ˆã¿ãƒ•ãƒ©ã‚°
                }

                this.uiManager.updatePlayerState(playerType, true);
                this.uiManager.updatePlayerStatus(playerType, 'å†ç”Ÿæº–å‚™ä¸­...');

                try {
                    const playbackDef = this.currentExercise.playbackDef;
                    if (playbackDef && playbackDef.length > 0) {
                        console.log('[ezmelo] ãƒ—ãƒ¬ã‚¤ãƒãƒƒã‚¯å®šç¾©ã«åŸºã¥ã„ã¦å†ç”Ÿã‚’é–‹å§‹ã—ã¾ã™');
                        const fullMidiData = await this.verovioManager.getMidiFromMei(this.currentExercise.meiURL);
                        await this.tonejsManager.loadFromVerovio(fullMidiData);

                        for (const def of playbackDef) {
                            const [startMeasure, endMeasure] = def.range.split('-').map(Number);
                            this.uiManager.updatePlayerStatus(playerType, `â–¶ ${startMeasure}-${endMeasure}å°ç¯€ç›®ã‚’å†ç”Ÿä¸­...`);
                            await this.tonejsManager.playRange(startMeasure, endMeasure);
                            await new Promise(resolve => setTimeout(resolve, def.interval * 1000));
                        }
                    } else {
                        console.log('[ezmelo] å…¨å†ç”Ÿã‚’é–‹å§‹ã—ã¾ã™');
                        this.uiManager.updatePlayerStatus(playerType, 'â–¶ å…¨ä½“ã‚’å†ç”Ÿä¸­...');
                        const fullMidiData = await this.verovioManager.getMidiFromMei(this.currentExercise.meiURL);
                        await this.tonejsManager.loadFromVerovio(fullMidiData);
                        await this.tonejsManager.play();
                    }
                } catch (error) {
                    console.error('å†ç”Ÿä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                    this.uiManager.updatePlayerStatus(playerType, 'å†ç”Ÿã‚¨ãƒ©ãƒ¼');
                    this.uiManager.updatePlayerState(playerType, false);
                }
            }


            stop(playerType) {
                console.log('[ezmelo] å†ç”Ÿã‚’åœæ­¢ã—ã¾ã™');
                this.tonejsManager.stop();
                this.uiManager.updatePlayerStatus(playerType, 'â–  åœæ­¢');
                this.uiManager.updatePlayerState(playerType, false);
            }

            // å†ç”Ÿé–‹å§‹æ™‚ã®UIæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢
            handlePlaybackStart() {
                console.log('handlePlaybackStart called');
                this.uiManager.updatePlayerStatus('exercise', 'â–¶ å†ç”Ÿä¸­...');
                this.uiManager.updatePlayerState('exercise', true);
                this.uiManager.updatePlayerStatus('answer', 'â–¶ å†ç”Ÿä¸­...');
                this.uiManager.updatePlayerState('answer', true);
            }

            // å†ç”Ÿçµ‚äº†æ™‚ã®UIæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ†é›¢
            handlePlaybackEnd() {
                console.log('handlePlaybackEnd called');
                this.uiManager.updatePlayerStatus('exercise', 'â–  åœæ­¢');
                this.uiManager.updatePlayerState('exercise', false);
                this.uiManager.updatePlayerStatus('answer', 'â–  åœæ­¢');
                this.uiManager.updatePlayerState('answer', false);
            }


        }
    </script>

    <script type="module" defer>
        import { VerovioManager } from 'https://cdn.jsdelivr.net/gh/kogu0507/module@main/verovio/verovio-manager.min.js';
        import { TonejsManager } from 'https://cdn.jsdelivr.net/gh/kogu0507/module@main/tonejs/manager/tonejs-manager.js';
        // import { UIManager } from...
        // import { EasyMelodyDictationApp } from...

        const ids = {
            // èª²é¡Œæƒ…å ±
            exerciseInfo: 'ezmelo-exercise-info',
            playbackInfo: 'ezmelo-playback-info',

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é–¢é€£
            exercisePlayerSection: 'exercise-player-section',
            answerPlayerSection: 'answer-player-section',
            // æ¥½è­œè¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠ
            answerScoreContainer: 'answer-score-container',

            // JSONãƒ‡ãƒ¼ã‚¿
            jsonData: 'ezmelo-json-data',

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            playerTemplate: 'ezmelo-player-template',
            keyboardTemplate: 'ezmelo-keyboard-template',

            // ã‚¿ãƒ–ãƒ‘ãƒãƒ«
            tabPaneExerciseSelection: 'exercise-selection',
            tabPaneExercise: 'exercise',
            tabPaneAnswer: 'answer',
            tabPaneSettings: 'settings',

            // ç°¡æ˜“ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰
            exerciseKeyboardSection: 'exercise-keyboard-section',
            answerKeyboardSection: 'answer-keyboard-section'
        };

        const verovioManager = new VerovioManager();
        const tonejsManager = new TonejsManager();
        const uiManager = new UIManager(verovioManager, ids);
        const easyMelodyDictationApp = new EasyMelodyDictationApp(uiManager, verovioManager, tonejsManager);


        document.addEventListener("DOMContentLoaded", () => {
            easyMelodyDictationApp.initialize();
        });
    </script>

</body>

</html>